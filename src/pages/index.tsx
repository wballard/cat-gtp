import MessageDisplay from "@/components/message";
import { useMessages } from "@/model/messages";
import styles from "@/styles/Home.module.css";
import SendIcon from "@mui/icons-material/Send";
import GithubIcon from "@mui/icons-material/GitHub";
import {
  Box,
  Button,
  Divider,
  Grid,
  Input,
  LinearProgress,
  Stack,
  Typography,
} from "@mui/joy";
import Head from "next/head";
import React from "react";

export default function Home() {
  const [query, setQuery] = React.useState("");
  const { loading, messages, humanAsks } = useMessages();

  const sendMessage = React.useCallback(() => {
    if (!loading && query.length) {
      humanAsks(query);
      setQuery("");
    }
  }, [loading, query, humanAsks]);

  return (
    <>
      <Head>
        <title>CatGPT üêà</title>
        <meta name="description" content="Generated by create next app" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <Grid
        container
        spacing={2}
        sx={{
          flexGrow: 1,
          width: 1,
          height: 1,
          margin: 0,
        }}
      >
        <Grid className={styles.sidebar} xs={2} sx={{ height: 1 }}>
          <Button
            variant="plain"
            onClick={() =>
              window.location.assign("https://github.com/wballard/cat-gtp")
            }
          >
            <GithubIcon />
          </Button>
        </Grid>
        <Grid xs={10} sx={{ display: "flex", height: 1, padding: 0 }}>
          <Box sx={{ display: "flex", flexDirection: "column", flex: 1 }}>
            {loading && <LinearProgress sx={{ maxHeight: "1em" }} />}
            {messages.length === 0 && (
              <Box
                sx={{
                  display: "flex",
                  flex: 1,
                  width: 1,
                  justifyContent: "center",
                  padding: 2,
                }}
              >
                <Typography level="body2" sx={{ fontStyle: "italic" }}>
                  Technology does repeat itself. And it rhymes.
                </Typography>
              </Box>
            )}
            <Stack sx={{ width: 1, flex: "1 1 auto", overflowY: "scroll" }}>
              {messages.map((message, i) => {
                return (
                  <Box key={i}>
                    <MessageDisplay
                      message={message}
                      index={i}
                      scrollToMe={i === messages.length - 1}
                    />
                    <Divider />
                  </Box>
                );
              })}
            </Stack>
            <Box
              sx={{
                display: "flex",
                justifyContent: "center",
                padding: 2,
                paddingBottom: 12,
              }}
            >
              <Input
                sx={{
                  boxShadow: "sm",
                  flex: 1,
                  maxWidth: "40em",
                }}
                endDecorator={
                  <Button variant="plain" onClick={() => sendMessage()}>
                    <SendIcon />
                  </Button>
                }
                value={query}
                onChange={(e) => {
                  setQuery(e.target.value);
                }}
                onKeyUp={(e) => {
                  if (e.key === "Enter") {
                    sendMessage();
                  }
                }}
                placeholder="Chat with the cat..."
              />
            </Box>
          </Box>
        </Grid>
      </Grid>
    </>
  );
}
